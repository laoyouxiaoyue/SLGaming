name: Go

on:
  push:
    branches: [ "main" ]

env:
  GO_VERSION: '1.25.5'
  PROJECT_PATH: 'back'
  BUILD_DIR: 'build'

jobs:
  build:
    name: Build Microservices
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build Gateway Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/gateway \
            ./services/gateway/gateway.go

      - name: Build User Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/user \
            ./services/user/user.go

      - name: Build Order Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/order \
            ./services/order/order.go

      - name: Build Code Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/code \
            ./services/code/code.go

      - name: Package deployment files
        run: |
          mkdir -p ${{ env.BUILD_DIR }}/deploy

          cp ${{ env.BUILD_DIR }}/gateway ${{ env.BUILD_DIR }}/deploy/
          cp ${{ env.BUILD_DIR }}/user    ${{ env.BUILD_DIR }}/deploy/
          cp ${{ env.BUILD_DIR }}/order   ${{ env.BUILD_DIR }}/deploy/
          cp ${{ env.BUILD_DIR }}/code    ${{ env.BUILD_DIR }}/deploy/

          cp -r ${{ env.PROJECT_PATH }}/services/gateway/etc ${{ env.BUILD_DIR }}/deploy/gateway-etc
          cp -r ${{ env.PROJECT_PATH }}/services/user/etc    ${{ env.BUILD_DIR }}/deploy/user-etc
          cp -r ${{ env.PROJECT_PATH }}/services/order/etc   ${{ env.BUILD_DIR }}/deploy/order-etc
          cp -r ${{ env.PROJECT_PATH }}/services/code/etc    ${{ env.BUILD_DIR }}/deploy/code-etc

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: microservices-binaries
          path: ${{ env.BUILD_DIR }}/deploy/
          retention-days: 7

  deploy:
    name: Deploy Microservices
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: microservices-binaries
          path: ${{ env.BUILD_DIR }}/

      - name: Upload files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "${{ env.BUILD_DIR }}/*"
          target: ${{ secrets.DEPLOY_PATH }}

      - name: Restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: false
          script: |
            set -e

            # ⚠️ 关键点：真正的程序在 build 目录里
            cd ${{ secrets.DEPLOY_PATH }}/build

            echo "=== Current dir ==="
            pwd
            echo "=== Files ==="
            ls -lh

            echo "=== Stop old services ==="
            pkill -f "gateway -f" || true
            pkill -f "user -f" || true
            pkill -f "order -f" || true
            pkill -f "code -f" || true
            sleep 2

            echo "=== Start services ==="
            chmod +x gateway user order code

            nohup ./gateway -f gateway-etc/gateway.yaml > gateway.log 2>&1 </dev/null &
            nohup ./user    -f user-etc/user.yaml       > user.log    2>&1 </dev/null &
            nohup ./order   -f order-etc/order.yaml     > order.log   2>&1 </dev/null &
            nohup ./code    -f code-etc/code.yaml       > code.log    2>&1 </dev/null &

            sleep 2

            echo "=== Process check ==="
            ps aux | grep -E "(gateway|user|order|code)" | grep -v grep

            echo "=== Logs ==="
            tail -5 gateway.log || true
            tail -5 user.log || true
            tail -5 order.log || true
            tail -5 code.log || true

            echo "✅ Deploy finished"
