name: Build and Deploy with Docker

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated: gateway,user,order,code,agent or "all")'
        required: false
        default: 'all'
      force_build:
        description: 'Force rebuild all services (ignore change detection)'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: "1.25.5"
  PROJECT_PATH: "back"
  IMAGE_PREFIX: "slgaming"

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.filter.outputs.gateway }}
      user: ${{ steps.filter.outputs.user }}
      order: ${{ steps.filter.outputs.order }}
      code: ${{ steps.filter.outputs.code }}
      agent: ${{ steps.filter.outputs.agent }}
      any: ${{ steps.filter.outputs.changes != '[]' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            gateway:
              - 'back/services/gateway/**'
              - 'back/pkg/**'
              - 'back/rpc/**'
            user:
              - 'back/services/user/**'
              - 'back/pkg/**'
              - 'back/rpc/**'
            order:
              - 'back/services/order/**'
              - 'back/pkg/**'
              - 'back/rpc/**'
            code:
              - 'back/services/code/**'
              - 'back/pkg/**'
              - 'back/rpc/**'
            agent:
              - 'back/services/agent/**'
              - 'back/pkg/**'
              - 'back/rpc/**'

      - name: Determine services to build
        id: determine
        run: |
          # Handle manual trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            INPUT="${{ github.event.inputs.services }}"
            FORCE="${{ github.event.inputs.force_build }}"
            
            if [ "$INPUT" == "all" ] || [ "$FORCE" == "true" ]; then
              echo "Building all services (manual trigger)"
              echo "gateway=true" >> $GITHUB_OUTPUT
              echo "user=true" >> $GITHUB_OUTPUT
              echo "order=true" >> $GITHUB_OUTPUT
              echo "code=true" >> $GITHUB_OUTPUT
              echo "agent=true" >> $GITHUB_OUTPUT
            else
              IFS=',' read -ra SERVICES <<< "$INPUT"
              for s in "${SERVICES[@]}"; do
                s=$(echo "$s" | tr -d ' ')
                echo "$s=true" >> $GITHUB_OUTPUT
              done
            fi
          fi
          echo "Change detection results:"
          echo "  gateway: ${{ steps.filter.outputs.gateway }}"
          echo "  user: ${{ steps.filter.outputs.user }}"
          echo "  order: ${{ steps.filter.outputs.order }}"
          echo "  code: ${{ steps.filter.outputs.code }}"
          echo "  agent: ${{ steps.filter.outputs.agent }}"

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Gateway Docker Image
        if: needs.detect-changes.outputs.gateway == 'true' || github.event.inputs.force_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_PATH }}
          file: ${{ env.PROJECT_PATH }}/services/gateway/Dockerfile
          push: false
          tags: ${{ env.IMAGE_PREFIX }}/gateway:latest,${{ env.IMAGE_PREFIX }}/gateway:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Build User Docker Image
        if: needs.detect-changes.outputs.user == 'true' || github.event.inputs.force_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_PATH }}
          file: ${{ env.PROJECT_PATH }}/services/user/Dockerfile
          push: false
          tags: ${{ env.IMAGE_PREFIX }}/user:latest,${{ env.IMAGE_PREFIX }}/user:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Build Order Docker Image
        if: needs.detect-changes.outputs.order == 'true' || github.event.inputs.force_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_PATH }}
          file: ${{ env.PROJECT_PATH }}/services/order/Dockerfile
          push: false
          tags: ${{ env.IMAGE_PREFIX }}/order:latest,${{ env.IMAGE_PREFIX }}/order:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Build Code Docker Image
        if: needs.detect-changes.outputs.code == 'true' || github.event.inputs.force_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_PATH }}
          file: ${{ env.PROJECT_PATH }}/services/code/Dockerfile
          push: false
          tags: ${{ env.IMAGE_PREFIX }}/code:latest,${{ env.IMAGE_PREFIX }}/code:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Build Agent Docker Image
        if: needs.detect-changes.outputs.agent == 'true' || github.event.inputs.force_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_PATH }}
          file: ${{ env.PROJECT_PATH }}/services/agent/Dockerfile
          push: false
          tags: ${{ env.IMAGE_PREFIX }}/agent:latest,${{ env.IMAGE_PREFIX }}/agent:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Save Docker Images
        run: |
          mkdir -p docker-images
          echo "=== Saving Docker Images ==="
          
          if docker images | grep -q "${{ env.IMAGE_PREFIX }}/gateway"; then
            docker save ${{ env.IMAGE_PREFIX }}/gateway:latest | gzip > docker-images/gateway.tar.gz
            echo "✅ gateway image saved"
          else
            echo "⚠️ gateway image not built, skipping"
          fi
          
          if docker images | grep -q "${{ env.IMAGE_PREFIX }}/user"; then
            docker save ${{ env.IMAGE_PREFIX }}/user:latest | gzip > docker-images/user.tar.gz
            echo "✅ user image saved"
          else
            echo "⚠️ user image not built, skipping"
          fi
          
          if docker images | grep -q "${{ env.IMAGE_PREFIX }}/order"; then
            docker save ${{ env.IMAGE_PREFIX }}/order:latest | gzip > docker-images/order.tar.gz
            echo "✅ order image saved"
          else
            echo "⚠️ order image not built, skipping"
          fi
          
          if docker images | grep -q "${{ env.IMAGE_PREFIX }}/code"; then
            docker save ${{ env.IMAGE_PREFIX }}/code:latest | gzip > docker-images/code.tar.gz
            echo "✅ code image saved"
          else
            echo "⚠️ code image not built, skipping"
          fi
          
          if docker images | grep -q "${{ env.IMAGE_PREFIX }}/agent"; then
            docker save ${{ env.IMAGE_PREFIX }}/agent:latest | gzip > docker-images/agent.tar.gz
            echo "✅ agent image saved"
          else
            echo "⚠️ agent image not built, skipping"
          fi
          
          echo "=== Saved images ==="
          ls -lh docker-images/ || true

      - name: Upload Docker Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/
          retention-days: 7

  deploy:
    name: Deploy Docker Containers
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download Docker Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: docker-images/

      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying Downloaded Files ==="
          ls -lh docker-images/ || true

      - name: Load Docker Images on Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "docker-images/*.tar.gz"
          target: "${{ secrets.DEPLOY_PATH }}/docker-images"
          strip_components: 1

      - name: Deploy Services with Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 10m
          script: |
            set -euo pipefail
            
            echo "=== Deployment Configuration ==="
            echo "Gateway: ${{ needs.detect-changes.outputs.gateway }}"
            echo "User: ${{ needs.detect-changes.outputs.user }}"
            echo "Order: ${{ needs.detect-changes.outputs.order }}"
            echo "Code: ${{ needs.detect-changes.outputs.code }}"
            echo "Agent: ${{ needs.detect-changes.outputs.agent }}"
            
            cd ${{ secrets.DEPLOY_PATH }}/docker-images
            
            echo "=== Loading Docker Images ==="
            update_gateway=0
            update_user=0
            update_order=0
            update_code=0
            update_agent=0

            if [ -f gateway.tar.gz ]; then
              echo "Loading gateway image..."
              docker load -i gateway.tar.gz && update_gateway=1
              echo "✅ gateway loaded"
            fi
            
            if [ -f user.tar.gz ]; then
              echo "Loading user image..."
              docker load -i user.tar.gz && update_user=1
              echo "✅ user loaded"
            fi
            
            if [ -f order.tar.gz ]; then
              echo "Loading order image..."
              docker load -i order.tar.gz && update_order=1
              echo "✅ order loaded"
            fi
            
            if [ -f code.tar.gz ]; then
              echo "Loading code image..."
              docker load -i code.tar.gz && update_code=1
              echo "✅ code loaded"
            fi

            if [ -f agent.tar.gz ]; then
              echo "Loading agent image..."
              docker load -i agent.tar.gz && update_agent=1
              echo "✅ agent loaded"
            fi

            echo "=== Stopping Old Containers ==="
            [ "$update_gateway" -eq 1 ] && docker stop slgaming-gateway 2>/dev/null || true
            [ "$update_user" -eq 1 ] && docker stop slgaming-user 2>/dev/null || true
            [ "$update_order" -eq 1 ] && docker stop slgaming-order 2>/dev/null || true
            [ "$update_code" -eq 1 ] && docker stop slgaming-code 2>/dev/null || true
            [ "$update_agent" -eq 1 ] && docker stop slgaming-agent 2>/dev/null || true

            [ "$update_gateway" -eq 1 ] && docker rm slgaming-gateway 2>/dev/null || true
            [ "$update_user" -eq 1 ] && docker rm slgaming-user 2>/dev/null || true
            [ "$update_order" -eq 1 ] && docker rm slgaming-order 2>/dev/null || true
            [ "$update_code" -eq 1 ] && docker rm slgaming-code 2>/dev/null || true
            [ "$update_agent" -eq 1 ] && docker rm slgaming-agent 2>/dev/null || true
            
            echo "=== Starting New Containers ==="
            echo "Deployment order: Code -> User -> Order -> Agent -> Gateway"
            
            # Code Service (gRPC: 8085, Metrics: 9085)
            if [ "$update_code" -eq 1 ]; then
              echo "Starting Code Service..."
              docker run -d \
                --name slgaming-code \
                --restart unless-stopped \
                -p 8085:8085 \
                -p 9085:9085 \
                ${{ env.IMAGE_PREFIX }}/code:latest
            fi
            
            # User Service (gRPC: 8086, Metrics: 9086)
            if [ "$update_user" -eq 1 ]; then
              echo "Starting User Service..."
              docker run -d \
                --name slgaming-user \
                --restart unless-stopped \
                -p 8086:8086 \
                -p 9086:9086 \
                ${{ env.IMAGE_PREFIX }}/user:latest
            fi
            
            # Order Service (gRPC: 8087, Metrics: 9087)
            if [ "$update_order" -eq 1 ]; then
              echo "Starting Order Service..."
              docker run -d \
                --name slgaming-order \
                --restart unless-stopped \
                -p 8087:8087 \
                -p 9087:9087 \
                ${{ env.IMAGE_PREFIX }}/order:latest
            fi

            # Agent Service (gRPC: 8090, Metrics: 9090)
            if [ "$update_agent" -eq 1 ]; then
              echo "Starting Agent Service..."
              docker run -d \
                --name slgaming-agent \
                --restart unless-stopped \
                -p 8090:8090 \
                ${{ env.IMAGE_PREFIX }}/agent:latest
            fi
            
            # Wait for backend services
            echo "=== Waiting for backend services ==="
            sleep 30
            
            # Gateway Service (HTTP: 8888, Metrics: 9888)
            if [ "$update_gateway" -eq 1 ]; then
              echo "Starting Gateway Service..."
              docker run -d \
                --name slgaming-gateway \
                --restart unless-stopped \
                -p 8888:8888 \
                -p 9888:9888 \
                ${{ env.IMAGE_PREFIX }}/gateway:latest
            fi
            
            sleep 5
            
            echo "=== Container Status ==="
            docker ps -a | grep slgaming || true
            
            echo "=== Checking Logs for Updated Services ==="
            [ "$update_gateway" -eq 1 ] && docker logs --tail 30 slgaming-gateway || true
            [ "$update_code" -eq 1 ] && docker logs --tail 30 slgaming-code || true
            [ "$update_user" -eq 1 ] && docker logs --tail 30 slgaming-user || true
            [ "$update_order" -eq 1 ] && docker logs --tail 30 slgaming-order || true
            [ "$update_agent" -eq 1 ] && docker logs --tail 30 slgaming-agent || true
            
            echo "✅ Deployment completed"
