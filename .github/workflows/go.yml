name: Go

on:
  push:
    branches: ["main"]

env:
  GO_VERSION: "1.25.5"
  PROJECT_PATH: "back"
  BUILD_DIR: "build"

jobs:
  build:
    name: Build Microservices
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.PROJECT_PATH }}/go.sum

      - name: Build Gateway Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/gateway \
            ./services/gateway/gateway.go

      - name: Build User Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/user \
            ./services/user/user.go

      - name: Build Order Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/order \
            ./services/order/order.go

      - name: Build Code Service
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          mkdir -p ../${{ env.BUILD_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o ../${{ env.BUILD_DIR }}/code \
            ./services/code/code.go

      - name: Package deployment files
        run: |
          mkdir -p ${{ env.BUILD_DIR }}/deploy

          # binaries
          cp ${{ env.BUILD_DIR }}/gateway ${{ env.BUILD_DIR }}/deploy/
          cp ${{ env.BUILD_DIR }}/user    ${{ env.BUILD_DIR }}/deploy/
          cp ${{ env.BUILD_DIR }}/order   ${{ env.BUILD_DIR }}/deploy/
          cp ${{ env.BUILD_DIR }}/code    ${{ env.BUILD_DIR }}/deploy/

          # configs
          cp -r ${{ env.PROJECT_PATH }}/services/gateway/etc ${{ env.BUILD_DIR }}/deploy/gateway-etc
          cp -r ${{ env.PROJECT_PATH }}/services/user/etc    ${{ env.BUILD_DIR }}/deploy/user-etc
          cp -r ${{ env.PROJECT_PATH }}/services/order/etc   ${{ env.BUILD_DIR }}/deploy/order-etc
          cp -r ${{ env.PROJECT_PATH }}/services/code/etc    ${{ env.BUILD_DIR }}/deploy/code-etc

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: microservices-binaries
          path: ${{ env.BUILD_DIR }}/deploy/
          retention-days: 7

  deploy:
    name: Deploy Microservices
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: microservices-binaries
          path: ${{ env.BUILD_DIR }}/deploy/

      # 关键：先在服务器创建目标目录，避免 scp 传不上/传到奇怪位置
      - name: Ensure remote build dir exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            mkdir -p ${{ secrets.DEPLOY_PATH }}/build

      # 关键：把 deploy 目录内容“平铺”到服务器的 DEPLOY_PATH/build 下
      - name: Upload files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "${{ env.BUILD_DIR }}/deploy/*"
          target: "${{ secrets.DEPLOY_PATH }}/build"
          strip_components: 2

      - name: Restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 5m
          script: |
            set -euo pipefail
            cd ${{ secrets.DEPLOY_PATH }}/build

            echo "=== Deploy dir ==="
            pwd
            ls -lh

            echo "=== Stop old services ==="
            pkill -f "gateway -f" || true
            pkill -f "code -f" || true
            pkill -f "user -f" || true
            pkill -f "order -f" || true
            sleep 2

            echo "=== Start services (nohup) ==="
            chmod +x gateway code user order

            nohup ./gateway -f gateway-etc/gateway.yaml > gateway.log 2>&1 </dev/null &
            nohup ./code    -f code-etc/code.yaml       > code.log    2>&1 </dev/null &
            nohup ./user    -f user-etc/user.yaml       > user.log    2>&1 </dev/null &
            nohup ./order   -f order-etc/order.yaml     > order.log   2>&1 </dev/null &

            sleep 2

            echo "=== Process check ==="
            ps aux | grep -E "(./gateway -f|./code -f|./user -f|./order -f)" | grep -v grep || true

            ok=1
            ps aux | grep -E "./gateway -f" | grep -v grep >/dev/null || ok=0
            ps aux | grep -E "./code -f"    | grep -v grep >/dev/null || ok=0
            ps aux | grep -E "./user -f"    | grep -v grep >/dev/null || ok=0
            ps aux | grep -E "./order -f"   | grep -v grep >/dev/null || ok=0

            if [ "$ok" -ne 1 ]; then
              echo "❌ One or more services failed to start. Logs:"
              echo "----- gateway.log -----"; tail -200 gateway.log || true
              echo "----- code.log -----";    tail -200 code.log || true
              echo "----- user.log -----";    tail -200 user.log || true
              echo "----- order.log -----";   tail -200 order.log || true
              exit 1
            fi

            echo "✅ Services deployment completed"
